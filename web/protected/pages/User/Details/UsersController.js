var PageJs=new Class.create();PageJs.prototype=Object.extend(new BPCPageJs(),{_user:null,_roles:[],_savePanelId:"",_editUrl:"",setHtmlIDs:function(a){this._savePanelId=a;return this},setEditUrl:function(a){this._editUrl=a;return this},_getFieldDiv:function(b,a){return new Element("span",{"class":"fieldDiv"}).insert({bottom:new Element("span",{"class":"title"}).update(b)}).insert({bottom:new Element("span",{"class":"content"}).update(a)})},_getRoleSelBox:function(){var a={};a.me=this;a.oldRoleIds=[];if(a.me._user){a.me._user.roles.each(function(b){a.oldRoleIds.push(b.id)})}a.selBox=new Element("select");a.me._roles.each(function(b){a.opt=new Element("option",{value:b.id}).update(b.name);if(a.oldRoleIds.indexOf(b.id)>=0){a.opt.writeAttribute("selected",true)}a.selBox.insert({bottom:a.opt})});return a.selBox},_chkPassword:function(c,a){var b={};b.me=this;$$(".errorMsgDiv.passNotMatch").each(function(d){d.remove()});b.isSame=($F(c)===$F(a));if(!b.isSame){$(a).insert({after:new Element("div",{"class":"passNotMatch msgDiv errorMsgDiv"}).update(new Element("div",{"class":"msg"}).update("Password do NOT match!"))})}return b.isSame},_collectData:function(b){var a={};a.me=this;a.data={userid:(a.me._user?a.me._user.id:"")};a.savePanel=$(b).up("#"+a.me._savePanelId);a.savePanel.getElementsBySelector(".msgDiv").each(function(c){c.remove()});a.hasError=false;if(a.savePanel){a.hasError=!a.me._chkPassword(a.savePanel.down("[password=new]"),a.savePanel.down("[password=confirm]"));a.savePanel.getElementsBySelector("[save_panel]").each(function(c){a.fieldName=$(c).readAttribute("save_panel");a.isMand=$(c).readAttribute("mandatory");a.isMand=(a.isMand&&(a.isMand*1)===1?true:false);if(a.isMand===true&&$F(c).blank()){$(c).insert({after:new Element("div",{"class":"msgDiv errorMsgDiv"}).update(new Element("div",{"class":"msg"}).update(a.fieldName+" is mandatory!"))});a.hasError=true}a.data[a.fieldName]=$F(c)})}return a.hasError===true?null:a.data},_saveUser:function(b){var a={};a.me=this;a.data=a.me._collectData(b);if(a.data===null){return a.me}a.me.postAjax(a.me.getCallbackId("saveUser"),a.data,{onLoading:function(){$(b).store("originalValue",$(b).innerHTML).addClassName("disabled").update("Saving ...")},onSuccess:function(c,f){try{a.result=a.me.getResp(f,false,true);if(!a.result){return}alert("User Saved Successfully");window.location=a.me._editUrl.replace("{uid}",a.result.id)}catch(d){alert(d)}},onComplete:function(){if($(b)){$(b).removeClassName("disabled").update($(b).retrieve("originalValue"))}}});return a.me},_getSavePanel:function(){var a={};a.me=this;a.firstName=a.me._user?a.me._user.person.firstName:"";a.lastName=a.me._user?a.me._user.person.lastName:"";a.username=a.me._user?a.me._user.username:"";a.newPanel=new Element("div",{"class":"savePanel"}).insert({bottom:new Element("div",{"class":"row"}).insert({bottom:a.me._getFieldDiv("First Name:",new Element("input",{type:"text",save_panel:"firstName",value:a.firstName,mandatory:1}))}).insert({bottom:a.me._getFieldDiv("Last Name:",new Element("input",{type:"text",save_panel:"lastName",value:a.lastName,mandatory:1}))}).insert({bottom:a.me._getFieldDiv("Role:",a.me._getRoleSelBox().writeAttribute("save_panel","roleid").writeAttribute("mandatory",true))}).insert({bottom:a.me._getFieldDiv("Username:",new Element("input",{type:"text",save_panel:"userName",value:a.username,mandatory:1}))})}).insert({bottom:new Element("div",{"class":"row"}).insert({bottom:a.me._getFieldDiv("New Password:",new Element("input",{type:"password",save_panel:"newpassword",password:"new",value:"",mandatory:(a.me._user?0:1)}).observe("change",function(){a.me._chkPassword(this,$(this).up(".row").down("[password=confirm]"))}))}).insert({bottom:a.me._getFieldDiv("Confirm Password:",new Element("input",{type:"password",password:"confirm",value:""}).observe("change",function(){a.me._chkPassword($(this).up(".row").down("[password=new]"),this)}))})}).insert({bottom:new Element("div",{"class":"row"}).insert({bottom:new Element("span",{"class":"button"}).update("Save").observe("click",function(){a.me._saveUser(this)})})});return a.newPanel},load:function(a,c){var b={};b.me=this;b.me._user=a;b.me._roles=c;if($(b.me._savePanelId)){$(b.me._savePanelId).update(b.me._getSavePanel())}return b.me}});