var PageJs=new Class.create;PageJs.prototype=Object.extend(new DetailsPageJs,{_preSetData:{},setTaskStatuses:function(e){var t={};return t.me=this,t.me._statuses=e,t.me},setPreSetData:function(e){var t={};return t.me=this,t.me._preSetData=e,t.me},refreshParentWindow:function(e){var t={};t.me=this,window.parent&&(t.parentWindow=window.parent,t.parentWindow.pageJs.refreshResultRow&&t.parentWindow.pageJs.refreshResultRow(e))},_preSubmit:function(e){var t={};return t.me=this,$(e)&&$(e).hasClassName("save-btn")?(t.data={},t.me._item.id&&(t.data.id=t.me._item.id),$(e).up(".task-details-wrapper").getElementsBySelector("[save-panel]").each(function(e){t.field=e.readAttribute("save-panel"),e.hasClassName("datepicker")?(t.me._signRandID(e),t.value=jQuery("#"+e.id).data("DateTimePicker").date().utc().format()):(e.hasClassName("rich-text")&&(e.retrieve("editor").toggle(),e.retrieve("editor").toggle()),t.value=$F(e)),t.data[t.field]=t.value}),t.me.saveItem(e,t.data,function(e){t.me.refreshParentWindow(e.item),t.me.showModalBox('<strong class="text-success">Saved</strong>','<h4 class="text-success">Task ('+e.item.id+") has been saved successfully</h4>"),e.url?window.location=e.url:window.parent&&window.parent.jQuery.fancybox&&window.parent.jQuery.fancybox.close&&window.parent.jQuery.fancybox.close()}),t.me):t.me},_getItemDiv:function(){var e={};return e.me=this,e.newDiv=new Element("div",{"class":"task-details-wrapper"}).insert({bottom:new Element("div",{"class":"text-center"}).insert({bottom:new Element("h3").update(e.me._item.id?"Editing Task :"+e.me._item.id:"Creating a new Task")})}).insert({bottom:new Element("div").insert({bottom:new Element("div",{"class":"col-sm-3"}).insert({bottom:e.me.getFormGroup(new Element("label").update("Customer: "),new Element("input",{"class":"form-control select2","save-panel":"customerId",name:"customer",placeholder:"search a customer name here"}))})}).insert({bottom:new Element("div",{"class":"col-sm-2"}).insert({bottom:e.me.getFormGroup(new Element("label").update("Due Date: "),new Element("input",{"class":"form-control datepicker","save-panel":"dueDate",name:"dueDate",value:e.me._item.id?moment(e.me.loadUTCTime(e.me._item.dueDate)).format("DD/MM/YYYY hh:mm A"):""}))})}).insert({bottom:e.me._item.id?new Element("div",{"class":"col-sm-1"}).insert({bottom:e.me.getFormGroup(new Element("label").update("Status: "),e.statusList=new Element("select",{"class":"form-control select2","save-panel":"statusId"}))}):""}).insert({bottom:new Element("div",{"class":"col-sm-2"}).insert({bottom:e.me.getFormGroup(new Element("label").update("Technician: "),new Element("input",{"class":"form-control select2","save-panel":"techId",placeholder:"search a tech name here"}))})}).insert({bottom:new Element("div",{"class":e.me._item.id?"col-sm-4":"col-sm-5"}).insert({bottom:e.me.getFormGroup(new Element("label").update("From Order: "),e.me._item.order&&e.me._item.order.id?new Element("a").update(e.me._item.order.orderNo):new Element("input",{"class":"form-control select2","save-panel":"orderId",placeholder:"search a Order here"}))})})}).insert({bottom:new Element("div").insert({bottom:new Element("div",{"class":"col-sm-12"}).insert({bottom:e.me.getFormGroup(new Element("label").update("Instructions: "),new Element("textarea",{"class":"form-control rich-text","save-panel":"instructions",rows:10,name:"instructions"}).update(e.me._item.id?e.me._item.instructions:""))})})}).insert({bottom:new Element("div").insert({bottom:new Element("div",{"class":"col-sm-12"}).insert({bottom:e.me._item.id?new Element("div",{"class":"comments-div"}):""})})}).insert({bottom:new Element("div").insert({bottom:e.submitBtn=new Element("button",{type:"submit","class":"btn btn-primary col-sm-3 col-sm-offset-9 save-btn"}).update("save")})}),e.me._signRandID(e.submitBtn),e.statusList&&e.me._statuses.each(function(t){e.option=new Element("option",{value:t.id}).update(t.name),e.me._item.id&&t.id===e.me._item.status.id&&e.option.writeAttribute("selected",!0),e.statusList.insert({bottom:e.option})}),e.newDiv},_loadRichTextEditor:function(e){var t={};return t.me=this,t.me._signRandID(e),t.editor=new TINY.editor.edit("editor",{id:e.id,width:"100%",height:180,cssclass:"tinyeditor",controlclass:"tinyeditor-control",rowclass:"tinyeditor-header",dividerclass:"tinyeditor-divider",controls:["bold","italic","underline","strikethrough","|","subscript","superscript","|","orderedlist","unorderedlist","|","outdent","indent","|","leftalign","centeralign","rightalign","blockjustify","|","unformat","|","undo","redo","n","font","size","style","|","image","hr","link","unlink","|","print"],footer:!0,fonts:["Verdana","Arial","Georgia","Trebuchet MS"],xhtml:!0,cssfile:"custom.css",bodyid:"editor",footerclass:"tinyeditor-footer",toggle:{text:"source",activetext:"wysiwyg",cssclass:"toggle"},resize:{cssclass:"resize"}}),e.store("editor",t.editor),t.me},_formatOrderSelection:function(e){return'<div class="row order_item"><div class="col-xs-3">'+e.orderNo+'</div><div class="col-xs-2"><small>'+e.type+'</small></div><div class="col-xs-2" order_status="'+e.status.name+'"><small>'+e.status.name+'</small></div><div class="col-xs-5"><small>'+(e.customer&&e.customer.name?e.customer.name:"")+"</small></div></div >"},_initCustomerSearchBox:function(){var e={};return e.me=this,e.selectBox=jQuery('[save-panel="customerId"]').select2({minimumInputLength:3,multiple:!1,ajax:{delay:250,url:"/ajax/getAll",type:"POST",data:function(e){return{searchTxt:"name like ?",searchParams:["%"+e+"%"],entityName:"Customer",pageNo:1}},results:function(t,a,i){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t.id,text:t.name,data:t})}),{results:e.result}}},cache:!0,escapeMarkup:function(e){return e}}),e.me._item.id&&e.me._item.customer&&e.me._item.customer.id?e.selectBox.select2("data",{id:e.me._item.customer.id,text:e.me._item.customer.name,data:e.me._item.customer}):e.me._preSetData&&e.me._preSetData.customer&&e.me._preSetData.customer.id&&e.selectBox.select2("data",{id:e.me._preSetData.customer.id,text:e.me._preSetData.customer.name,data:e.me._preSetData.customer}),e.me},_initOrderSearchBox:function(){var e={};return e.me=this,e.selectBox=jQuery('[save-panel="orderId"]').select2({minimumInputLength:3,multiple:!1,allowClear:!0,ajax:{delay:250,url:"/ajax/getAll",type:"POST",data:function(e){return{searchTxt:"orderNo like ?",searchParams:["%"+e+"%"],entityName:"Order",pageNo:1}},results:function(t,a,i){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t.id,text:t.orderNo,data:t})}),{results:e.result}}},cache:!0,formatResult:function(t){return t?e.me._formatOrderSelection(t.data):""},formatSelection:function(t){return t?e.me._formatOrderSelection(t.data):""},escapeMarkup:function(e){return e}}),e.me._item.id&&e.me._item.fromEntity&&e.me._item.fromEntity.id&&"Order"===e.me._item.fromEntityName?e.selectBox.select2("data",{id:e.me._item.fromEntity.id,text:e.me._item.fromEntity.orderNo,data:e.me._item.fromEntity}):e.me._preSetData&&e.me._preSetData.order&&e.me._preSetData.order.id&&e.selectBox.select2("data",{id:e.me._preSetData.order.id,text:e.me._preSetData.order.orderNo,data:e.me._preSetData.order}),e.me},_initTechSearchBox:function(){var e={};return e.me=this,jQuery('[save-panel="techId"]').select2({minimumInputLength:3,multiple:!1,allowClear:!0,hidden:!0,ajax:{delay:250,url:"/ajax/getAll",type:"POST",data:function(e){return{searchTxt:'personId in (select id from person p where concat(p.firstName, " ", p.lastName) like ?)',searchParams:["%"+e+"%"],entityName:"UserAccount",pageNo:1}},results:function(t,a,i){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t.id,text:t.person.fullname,data:t})}),{results:e.result}}},cache:!0,escapeMarkup:function(e){return e}}),e.me._item.id&&e.me._item.technician&&e.me._item.technician.id&&jQuery('[save-panel="techId"]').select2("data",{id:e.me._item.technician.id,text:e.me._item.technician.person.fullname,data:e.me._item.technician}),e.me},_initFormValdation:function(e,t){var a={};return a.me=this,a.mainForm=jQuery("#"+a.me.getHTMLID("main-form")),a.mainForm.formValidation({framework:"bootstrap",icon:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},excluded:":disabled",fields:{dueDate:{validators:{callback:{message:"The Due Date is required.",callback:function(e,t,a){return null!==jQuery(a).data("DateTimePicker").date()}}}},customer:{validators:{notEmpty:{message:"The customer is required."}}}}}).on("err.form.fv",function(e){e.preventDefault(),a.mainForm.data("formValidation").getSubmitButton()&&a.mainForm.data("formValidation").disableSubmitButtons(!1)}).on("success.form.fv",function(e){e.preventDefault(),a.mainForm.data("formValidation").getSubmitButton()&&a.mainForm.data("formValidation").disableSubmitButtons(!1),a.me._preSubmit(a.mainForm.data("formValidation").getSubmitButton().attr("id"))}),a.mainForm.find(".datepicker").on("dp.change dp.show",function(e){a.mainForm.formValidation("revalidateField","dueDate")}),a.mainForm.find('[name="customer"]').change(function(e){a.mainForm.formValidation("revalidateField","customer")}),a.me},load:function(){var e={};return e.me=this,$(e.me.getHTMLID("itemDiv")).update(e.div=e.me._getItemDiv()),jQuery(".datepicker").datetimepicker({format:"DD/MM/YYYY hh:mm A"}),e.me._loadRichTextEditor(e.div.down('[save-panel="instructions"]'))._initTechSearchBox()._initOrderSearchBox()._initCustomerSearchBox()._initFormValdation(),e.div.down(".comments-div")&&e.div.down(".comments-div").store("CommentsDivJs",new CommentsDivJs(e.me,"Task",e.me._item.id)._setDisplayDivId(e.div.down(".comments-div")).render()),e.me}});