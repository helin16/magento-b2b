var PageJs=new Class.create;PageJs.prototype=Object.extend(new CRUDPageJs,{_openinFB:!0,_getTitleRowData:function(){return{}},setOpenInFancyBox:function(e){var t={};return t.me=this,t.me._openinFB=e,t.me},setStatuses:function(e){var t={};return t.me=this,t.me._statuses=e,t.me},setPreSetData:function(e){var t={};return t.me=this,t.me._preSetData=e,t.me},getSearchCriteria:function(){var e={};return e.me=this,null===e.me._searchCriteria&&(e.me._searchCriteria={}),e.nothingTosearch=!0,$(e.me.searchDivId).getElementsBySelector("[search_field]").each(function(t){t.hasClassName("datepicker")?(e.me._signRandID(t),e.date=jQuery("#"+t.id).data("DateTimePicker").date(),e.me._searchCriteria[t.readAttribute("search_field")]=e.date):e.me._searchCriteria[t.readAttribute("search_field")]=$F(t),($F(t)instanceof Array&&$F(t).size()>0||"string"==typeof $F(t)&&!$F(t).blank())&&(e.nothingTosearch=!1)}),e.nothingTosearch===!0&&(e.me._searchCriteria=null),this},refreshTaskRow:function(e){var t={};return t.me=this,t.me.refreshResultRow(e)},refreshResultRow:function(e){var t={};return t.me=this,t.tbody=$(t.me.resultDivId).down("tbody"),t.tbody||(t.tbody=$(t.me.resultDivId)),t.row=t.tbody.down(".item_row[item_id="+e.id+"]"),t.row?t.row.replace(t.me._getResultRow(e,!1).addClassName("item_row")):t.tbody.insert({top:t.me._getResultRow(e,!1).addClassName("item_row")}),t.me},_openURL:function(e){var t={};return t.me=this,t.url=e,t.me._openinFB!==!0?(window.location=t.url,t.me):(jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",href:t.url}),t.me)},showTaskPage:function(e){var t={};return t.me=this,t.url="/task/"+(e&&e.id?e.id:"new")+".html?blanklayout=1",t.me._openURL(t.url)},showOrderDetailsPage:function(e){var t={};return t.me=this,e&&e.id?t.me._openURL("/orderdetails/"+e.id+".html?blanklayout=1"):t.me},showCustomerDetailsPage:function(e){var t={};return t.me=this,e&&e.id?t.me._openURL("/customer/"+e.id+".html?blanklayout=1"):t.me},_updateDueDateCell:function(e,t){var a={};return a.me=this,a.dueDateCell=t,a.nowUTC=moment().utc(),a.dueDateUTC=a.dueDateCell.retrieve("data"),a.me._preSetData&&a.me._preSetData.noDueDateStatusIds&&a.me._preSetData.noDueDateStatusIds.indexOf(e.status.id)>=0?a.me:(a.overDued=a.dueDateUTC.diff(a.nowUTC)<0,a.overDued===!0&&a.dueDateCell.up("td").addClassName("danger").writeAttribute("title","Overdued!!!"),a.diffHours=a.dueDateUTC.diff(a.nowUTC,"hours",!0).toFixed(1),Math.abs(a.diffHours)>24?a.dueDateCell.down(".left-time").update("<strong>"+a.dueDateUTC.diff(a.nowUTC,"days")+"</strong> <small>Day(s)</small>"):(a.dueDateCell.down(".left-time").update("<strong>"+a.diffHours+"</strong> <small>Hr(s)</small>"),a.overDued!==!0&&a.dueDateCell.up("td").removeClassName("danger").addClassName("warning").writeAttribute("title","About to be overdued")),a.me)},_actionTask:function(e,t){var a={};return a.me=this,a.me.postAjax(a.me.getCallbackId("actionTask"),e,{onSuccess:function(e,s){try{if(a.result=a.me.getResp(s,!1,!0),!a.result||!a.result.item||!a.result.item.id)return;a.me.refreshResultRow(a.result.item),"function"==typeof t&&t(a.result)}catch(n){a.me.hideModalBox(),a.me.showModalBox('<strong class="text-danger">Error</strong>',n)}}}),a.me},_preActionTask:function(e){var t={};return t.me=this,t.newDiv=new Element("div",{"class":"confirm-div"}).insert({bottom:new Element("div",{"class":"msg-div"})}).insert({bottom:new Element("div",{"class":"form-group"}).insert({bottom:new Element("label",{"class":"control-label"}).update(t.msg="Reason for action: "+e.method)}).insert({bottom:new Element("textarea",{"class":"form-control","confirm-div":"comments",placeholder:t.msg})})}).insert({bottom:new Element("div").insert({bottom:new Element("div",{"class":"btn btn-default"}).update("Cancel").observe("click",function(){t.me.hideModalBox()})}).insert({bottom:new Element("div",{"class":"btn btn-danger pull-right"}).update("Comfirm").observe("click",function(){return t.confirmDiv=$(this).up(".confirm-div"),t.confirmDiv.down(".msg-div").update(""),t.comments=$F(t.confirmDiv.down('[confirm-div="comments"]')),t.comments.blank()?void t.confirmDiv.down(".msg-div").update(t.me.getAlertBox("","Please provide some reason.").addClassName("alert-danger")):(e.comments=t.comments,void t.me._actionTask(e,function(){t.me.hideModalBox()}))})})}),t.me.hideModalBox(),t.me.showModalBox('<strong class="text-danger">Please Confirm</strong>',t.newDiv),t.me},_getTechCell:function(e){var t={};return t.me=this,t.techName=e.technician&&e.technician.id?e.technician.person.fullname:"",t.newDiv=new Element("div",{"class":"row"}).update(t.nameCell=new Element("span",{"class":"col-xs-10 truncate"}).update(t.techName)).insert({bottom:new Element("div",{"class":"pull-right"}).setStyle("margin: 0 5px 0 0;").update(t.btns=new Element("div",{"class":"btn-group btn-group-xs visible-xs visible-sm visible-md visible-lg"}))}),t.me._preSetData&&t.me._preSetData.noDueDateStatusIds&&t.me._preSetData.noDueDateStatusIds.indexOf(e.status.id)<0&&(t.techName.blank()?t.btns.insert({bottom:new Element("span",{"class":"btn btn-primary",title:"Take this Task"}).update("Take").observe("click",function(){t.me._actionTask({taskId:e.id,method:"take"})})}):t.me._preSetData&&t.me._preSetData.meId&&t.me._preSetData.meId===e.technician.id&&(t.btns.insert({bottom:new Element("span",{"class":"btn btn-success dropdown-toggle","data-toggle":"dropdown","aria-expanded":"false"}).update(new Element("span",{"class":"caret"}))}).insert({bottom:t.menu=new Element("ul",{"class":"dropdown-menu"}).insert({bottom:new Element("li").update("3"!==e.status.id?new Element("a",{href:"javascript:void(0);"}).update("Start").observe("click",function(){t.me._actionTask({taskId:e.id,method:"start"})}):new Element("a",{href:"javascript:void(0);"}).update("Finish").observe("click",function(){t.me._actionTask({taskId:e.id,method:"finish"})}))}).insert({bottom:new Element("li").update(new Element("a",{href:"javascript:void(0);"}).update("Release").observe("click",function(){t.me._actionTask({taskId:e.id,method:"release"})}))}).insert({bottom:new Element("li",{"class":"divider"})}).insert({bottom:new Element("li").update(new Element("a",{href:"javascript:void(0);"}).update('<strong class="text-danger">ON HOLD</strong>').observe("click",function(){t.me._preActionTask({taskId:e.id,method:"onHold"})}))}).insert({bottom:new Element("li").update(new Element("a",{href:"javascript:void(0);"}).update('<strong class="text-danger">CANCEL</strong>').observe("click",function(){t.me._preActionTask({taskId:e.id,method:"cancel"})}))})}),t.menu&&"3"===e.status.id&&(t.menu.insert({top:new Element("li",{"class":"divider"})}),t.menu.insert({top:new Element("li").update(new Element("a",{href:"javascript:void(0);"}).update("Build a Kit").observe("click",function(){t.me._openURL("/kit/new.html?taskid="+e.id+"&blanklayout=1")}))})))),t.techName.blank()||t.nameCell.writeAttribute("title",t.techName),t.newDiv},_getResultRow:function(e,t){var a={};return a.me=this,a.tag=a.isTitle===!0?"th":"td",a.isTitle=t||!1,a.row=new Element("tr",{"class":"order_item "+(a.isTitle===!0?"":"btn-hide-row"),item_id:a.isTitle===!0?"":e.id}).store("data",e).insert({bottom:new Element(a.tag,{"class":"col-xs-1"}).insert({bottom:a.isTitle===!0?"Task No.":new Element("a",{href:"javascript: void(0);",title:"view details"}).update(e.id).observe("click",function(){a.me.showTaskPage(e)})})}).insert({bottom:new Element(a.tag,{"class":"col-xs-1"}).insert({bottom:a.isTitle===!0?"Customer":new Element("a",{href:"javascript: void(0);","class":"truncate",title:e.customer.name}).update(e.customer.name).observe("click",function(){a.me.showCustomerDetailsPage(e.customer)})})}).insert({bottom:new Element(a.tag,{"class":"col-xs-2"}).insert({bottom:a.isTitle===!0?'Due Date<font class="pull-right">Time Left</font> ':a.dueDateCell=new Element("div",{"class":"row"}).store("data",a.dueDateUTC=moment(a.me.loadUTCTime(e.dueDate))).insert({bottom:new Element("div",{"class":"col-xs-6"}).update(new Element("small").update(a.dueDateUTC.format("DD/MMM/YYYY hh:mm A")))}).insert({bottom:new Element("div",{"class":"col-xs-6  text-right"}).update(new Element("span",{"class":"left-time"}).update(""))})})}).insert({bottom:new Element(a.tag,{"class":"col-xs-1",order_status:a.isTitle===!0?"":e.status.name,title:a.isTitle===!0?"":e.status.description}).insert({bottom:a.isTitle===!0?"Status":new Element("span").update(e.status.name)})}).insert({bottom:new Element(a.tag,{"class":"col-xs-1"}).insert({bottom:a.isTitle===!0?"Tech":a.me._getTechCell(e)})}).insert({bottom:new Element(a.tag,{"class":"col-xs-2 truncate"}).insert({bottom:a.isTitle===!0?"Instructions":new Element("a",{href:"javascript: void(0);",title:"click to view all"}).update(e.instructions.stripTags()).observe("click",function(){a.me.hideModalBox(),a.me.showModalBox("<strong>Instructions for Task: "+e.id+"</strong>",e.instructions)})})}).insert({bottom:new Element(a.tag,{"class":"col-xs-1"}).insert({bottom:a.isTitle===!0?"No. Of Kits":new Element("div").insert({bottom:new Element("div",{"class":"col-xs-8"}).update(e.noOfKits&&e.noOfKits>0?new Element("a",{href:"javascript: void(0);"}).update(e.noOfKits).observe("click",function(){a.me._openURL("/kits.html?nosearch=1&blanklayout=1&taskId="+e.id)}):"")}).insert({bottom:new Element("div",{"class":"col-xs-4"}).update(a.me._preSetData&&a.me._preSetData.meId&&a.me._preSetData.meId===e.technician.id&&e.status&&"3"===e.status.id?new Element("span",{"class":"btn btn-xs btn-success"}).insert({bottom:new Element("i",{"class":"fa fa-plus"})}).observe("click",function(){a.me._openURL("/kit/new.html?blanklayout=1&taskid="+e.id)}):"")})})}).insert({bottom:new Element(a.tag,{"class":"col-xs-2"}).insert({bottom:a.isTitle===!0?"Created From":e.fromEntity&&e.fromEntity.orderNo?new Element("div",{"class":"row"}).insert({bottom:new Element("div",{"class":"col-xs-3"}).update(e.fromEntity.type)}).insert({bottom:new Element("div",{"class":"col-xs-3",order_status:e.fromEntity.status.name}).update(e.fromEntity.status.name)}).insert({bottom:new Element("a",{"class":"col-xs-6",href:"javascript: void(0);",title:"view details"}).update(e.fromEntity.orderNo).observe("click",function(){a.me.showOrderDetailsPage(e.fromEntity)})}):""})}).insert({bottom:new Element(a.tag,{"class":"col-xs-1 truncate"}).insert({bottom:a.isTitle===!0?"Created By":new Element("div",{title:"By: "+e.createdBy.person.fullname+" @ "+moment(a.me.loadUTCTime(e.created)).format("DD/MMM/YYYY hh:mm A")}).insert({bottom:new Element("div",{"class":"col-xs-12"}).update(e.createdBy.person.fullname)})})}),a.dueDateCell&&a.me._updateDueDateCell(e,a.dueDateCell),a.row},_initOrderSearchBox:function(){var e={};return e.me=this,e.selectBox=jQuery('[search_field="ord.id"]').select2({minimumInputLength:3,multiple:!0,ajax:{delay:250,url:"/ajax/getAll",type:"POST",data:function(e){return{searchTxt:"orderNo like ?",searchParams:["%"+e+"%"],entityName:"Order",pageNo:1}},results:function(t,a,s){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t.id,text:t.orderNo,data:t})}),{results:e.result}}},cache:!0,formatResult:function(e){return e?'<div class="row order_item"><div class="col-xs-3">'+e.data.orderNo+'</div><div class="col-xs-3" order_status="'+e.data.status.name+'">'+e.data.status.name+'</div><div class="col-xs-6"><small>'+(e.data.customer&&e.data.customer.name?e.data.customer.name:"")+"</small></div></div >":""},escapeMarkup:function(e){return e}}),e.me._preSetData&&e.me._preSetData.order&&e.me._preSetData.order.id&&e.selectBox.select2("data",[{id:e.me._preSetData.order.id,text:e.me._preSetData.order.orderNo,data:e.me._preSetData.order}]),e.me},_initTechSearchBox:function(){var e={};return e.me=this,e.selectBox=jQuery('[search_field="techId"]').select2({minimumInputLength:3,multiple:!0,ajax:{delay:250,url:"/ajax/getAll",type:"POST",data:function(e){return{searchTxt:'personId in (select id from person p where concat(p.firstName, " ", p.lastName) like ?)',searchParams:["%"+e+"%"],entityName:"UserAccount",pageNo:1}},results:function(t,a,s){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t.id,text:t.person.fullname,data:t})}),{results:e.result}}},cache:!0,escapeMarkup:function(e){return e}}),e.me._preSetData&&e.me._preSetData.technician&&e.me._preSetData.technician.id&&e.selectBox.select2("data",[{id:e.me._preSetData.technician.id,text:e.me._preSetData.technician.person.fullname,data:e.me._preSetData.technician}]),e.me},_initCustomerSearchBox:function(){var e={};return e.me=this,e.selectBox=jQuery('[search_field="customer.id"]').select2({minimumInputLength:3,multiple:!0,ajax:{delay:250,url:"/ajax/getAll",type:"POST",data:function(e){return{searchTxt:"name like ?",searchParams:["%"+e+"%"],entityName:"Customer",pageNo:1}},results:function(t,a,s){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t.id,text:t.name,data:t})}),{results:e.result}}},cache:!0,escapeMarkup:function(e){return e}}),e.me._preSetData&&e.me._preSetData.customer&&e.me._preSetData.customer.id&&e.selectBox.select2("data",[{id:e.me._preSetData.customer.id,text:e.me._preSetData.customer.name,data:e.me._preSetData.customer}]),e.me},_initStatusSearchBox:function(){var e={};return e.me=this,e.preSelectedStatusIds=[],e.me._preSetData&&e.me._preSetData.statuses&&e.me._preSetData.statuses.each(function(t){e.preSelectedStatusIds.push(t.id)}),e.me._statuses&&e.me._statuses.size()>0&&$$('[search_field="statusId"]').first()&&e.me._statuses.each(function(t){$$('[search_field="statusId"]').first().insert({bottom:e.option=new Element("option",{value:t.id}).update(t.name)}),e.preSelectedStatusIds.indexOf(t.id)>=0&&e.option.writeAttribute("selected",!0)}),e.selectBox=jQuery('[search_field="statusId"]').select2(),e.me},init:function(){var e={};return e.me=this,jQuery(".datepicker").datetimepicker({format:"DD/MM/YYYY"}),e.me._initCustomerSearchBox()._initOrderSearchBox()._initTechSearchBox()._initStatusSearchBox(),$("searchBtn").observe("click",function(){e.me.getSearchCriteria().getResults(!0,30)}),e.me}});