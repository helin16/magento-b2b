var PageJs=new Class.create;PageJs.prototype=Object.extend(new BPCPageJs,{resultDivId:"",searchDivId:"",totalNoOfItemsId:"",_pagination:{pageNo:1,pageSize:10},_searchCriteria:{},_infoTypes:{},orderStatuses:[],_type:"INVOICE",_loadChosen:function(){return jQuery(".chosen").select2(),this},_bindSearchKey:function(){var e={};return e.me=this,$("searchDiv").getElementsBySelector("[search_field]").each(function(t){t.observe("keydown",function(t){e.me.keydown(t,function(){$("searchBtn").click()})})}),this},_loadStatuses:function(e){this.orderStatuses=e;var t={};return t.me=this,t.statusBox=$(t.me.searchDivId).down("#orderStatusId"),t.me.orderStatuses.each(function(e){t.statusBox.insert({bottom:new Element("option",{value:e.id}).update(e.name)})}),this},setSearchCriteria:function(e){var t={};return t.me=this,t.searchPanel=$(t.me.searchDivId),$H(e).each(function(e){if(t.field=e.key,t.value=e.value,t.fieldBox=t.searchPanel.down('[search_field="'+t.field+'"]'),t.fieldBox)for(t.optlength=t.fieldBox.options.length,t.i=0;t.i<t.optlength;t.i++)t.value.indexOf(1*t.fieldBox.options[t.i].value)>=0&&(t.fieldBox.options[t.i].selected=!0)}),t.me._loadChosen()._bindSearchKey(),this},getSearchCriteria:function(){var e={};return e.me=this,null===e.me._searchCriteria&&(e.me._searchCriteria={}),e.nothingTosearch=!0,$(e.me.searchDivId).getElementsBySelector("[search_field]").each(function(t){e.field=t.readAttribute("search_field"),t.hasClassName("datepicker")?(e.me._signRandID(t),e.date=jQuery("#"+t.id).data("DateTimePicker").date(),e.me._searchCriteria[e.field]=e.date?new Date(e.date.local().format("YYYY-MM-DDT"+("orderDate_from"===e.field||"invDate_from"===e.field?"00:00:00":"23:59:59"))):""):e.me._searchCriteria[e.field]=$F(t),($F(t)instanceof Array&&$F(t).size()>0||"string"==typeof $F(t)&&!$F(t).blank())&&(e.nothingTosearch=!1)}),e.nothingTosearch===!0&&(e.me._searchCriteria=null),this},getResults:function(e,t){var a={};return a.me=this,a.reset=e||!1,null===a.me._searchCriteria?void a.me.showModalBox("Warning","Nothing to search!",!0):(a.reset===!0&&(a.me._pagination.pageNo=1),a.me._pagination.pageSize=t||a.me._pagination.pageSize,a.me._searchCriteria["ord.type"]=a.me._type,a.me._searchCriteria.extraSearchCriteria=a.me._extraSearchCriteria?a.me._extraSearchCriteria:"",void a.me.postAjax(a.me.getCallbackId("getOrders"),{pagination:a.me._pagination,searchCriteria:a.me._searchCriteria},{onLoading:function(){jQuery("#searchBtn").button("loading"),jQuery(".popovershipping").popover("hide"),a.reset===!0&&($(a.me.totalNoOfItemsId).update("0"),$(a.me.totalSumId).update(a.me.getCurrency(0)),$(a.me.totalDueId).update(a.me.getCurrency(0)),$(a.me.resultDivId).update("").insert({after:new Element("div",{"class":"panel-body"}).update(a.me.getLoadingImg())}))},onSuccess:function(e,t){try{if(a.result=a.me.getResp(t,!1,!0),!a.result)return;$(a.me.totalNoOfItemsId).update(a.result.pageStats.totalRows),$(a.me.totalSumId).update(a.me.getCurrency(a.result.totalAmount)),$(a.me.totalDueId).update(new Element("span",{title:"Total Amt: "+a.me.getCurrency(a.result.totalAmount)+"\nTotal Paid: "+a.me.getCurrency(a.result.totalPaid)+"\nTotal Credited: "+a.me.getCurrency(a.result.totalCreditNoteValue)+"\nTotal PaidViaCrdit: "+a.me.getCurrency(a.result.paidViaCredit)}).update(a.me.getCurrency(a.result.totalAmount-a.result.totalPaid-a.result.totalCreditNoteValue+1*a.result.paidViaCredit))),a.resultDiv=$(a.me.resultDivId),a.reset===!0&&(a.titleRow={orderNo:"Order Info.",type:"Type",custName:"Customer Name",shippingAddr:"Shipping Address",invNo:"Invoice No.",status:{name:"Status"},totalDue:"Total Due",passPaymentCheck:"Payment Cleared?"},a.resultDiv.update(a.me._getResultRow(a.titleRow,!0).wrap(new Element("thead")))),a.resultDiv.getElementsBySelector(".paginWrapper").each(function(e){e.remove()}),a.tbody=$(a.resultDiv).down("tbody"),a.tbody||$(a.resultDiv).insert({bottom:a.tbody=new Element("tbody")}),a.result.items.each(function(e){a.tbody.insert({bottom:a.me._getResultRow(e)})}),a.result.pageStats.pageNumber<a.result.pageStats.totalPages&&a.resultDiv.insert({bottom:a.me._getNextPageBtn().addClassName("paginWrapper")}),a.resultDiv.getElementsBySelector(".popovershipping.newPopover").each(function(e){e.removeClassName("newPopover"),a.rowData=e.up(".order_item").retrieve("data"),jQuery("#"+e.id).popover({container:"body",title:'<div class="row"><div class="col-xs-10">Details for: '+a.rowData.orderNo+'</div><div class="col-xs-2"><a class="pull-right" href="javascript:void(0);" onclick="jQuery(\'#'+e.id+"').popover('hide');\"><strong>&times;</strong></a></div></div>",content:jQuery(".popover_content",jQuery("#"+e.id)).html(),html:!0,placement:"right",trigger:"manual"})})}catch(n){a.me.showModalBox('<strong class="text-danger">Error</strong>',n,!0)}},onComplete:function(){jQuery("#searchBtn").button("reset"),$(a.me.resultDivId).up(".panel").down(".panel-body")&&$(a.me.resultDivId).up(".panel").down(".panel-body").remove()}}))},_getNextPageBtn:function(){var e={};return e.me=this,new Element("tfoot").insert({bottom:new Element("tr").insert({bottom:new Element("td",{colspan:"11","class":"text-center"}).insert({bottom:new Element("span",{"class":"btn btn-primary","data-loading-text":"Fetching more results ..."}).update("Show More").observe("click",function(){e.me._pagination.pageNo=1*e.me._pagination.pageNo+1,jQuery(this).button("loading"),e.me.getResults()})})})})},_getOrderDetailsDiv:function(e){var t={};return t.me=this,t.custName=e.infos[t.me._infoTypes.custName][0].value,t.custEmail=e.infos[t.me._infoTypes.custEmail][0].value,new Element("div").insert({bottom:new Element("div").update('<span class="glyphicon glyphicon-user" title="Customer Name"></span>: '+t.custName)}).insert({bottom:new Element("div").update('<span class="glyphicon glyphicon-envelope" title="Customer Email"></span>: <a href="mailto:'+t.custEmail+'">'+t.custEmail+"</a>")}).insert({bottom:new Element("div").update('<span class="glyphicon glyphicon-shopping-cart" title="Order Date"></span>: '+e.orderDate)}).insert({bottom:new Element("div").update("<strong>Shipping</strong>:")}).insert({bottom:new Element("div").update('<span class="glyphicon glyphicon-user" title="Customer Name"></span>: '+e.address.shipping.contactName)}).insert({bottom:new Element("div").update('<span class="glyphicon glyphicon-phone-alt" title="Phone"></span>: '+e.address.shipping.contactNo)}).insert({bottom:new Element("div").update('<span class="glyphicon glyphicon-map-marker" title="Address"></span>: '+e.address.shipping.full)})},_getTitledDiv:function(e,t){return new Element("div",{"class":"field_div"}).insert({bottom:new Element("span",{"class":"inlineblock title"}).update(e)}).insert({bottom:new Element("span",{"class":"inlineblock divcontent"}).update(t)})},_openDetailsPage:function(e){var t={};return t.me=this,jQuery.fancybox({width:"95%",height:"95%",autoScale:!1,autoDimensions:!1,fitToView:!1,autoSize:!1,type:"iframe",href:"/orderdetails/"+e.id+".html?blanklayout=1",beforeClose:function(){e&&e.id&&$(t.me.resultDivId).down(".order_item[order_id="+e.id+"]")&&$$("iframe.fancybox-iframe").first().contentWindow.pageJs._order&&$(t.me.resultDivId).down(".order_item[order_id="+e.id+"]").replace(t.me._getResultRow($$("iframe.fancybox-iframe").first().contentWindow.pageJs._order))}}),t.me},_getOrderInfoCell:function(e){var t={};return t.me=this,t.quantity="n/a",t.custName="n/a",t.custEmail="n/a",e.infos&&null!==e.infos&&(t.me._infoTypes.qty in e.infos&&e.infos[t.me._infoTypes.qty].length>0&&(t.quantity=e.infos[t.me._infoTypes.qty][0].value),t.me._infoTypes.custName in e.infos&&e.infos[t.me._infoTypes.custName].length>0&&(t.custName=e.infos[t.me._infoTypes.custName][0].value),t.me._infoTypes.custEmail in e.infos&&e.infos[t.me._infoTypes.custEmail].length>0&&(t.custEmail=e.infos[t.me._infoTypes.custEmail][0].value)),t.newDiv=new Element("div").insert({bottom:new Element("span").insert({bottom:t.orderLink=new Element("a",{id:"orderno-btn-"+e.id,"class":"orderNo visible-xs visible-sm visible-md visible-lg newPopover popovershipping",href:"javascript:void(0);"}).update(e.orderNo).insert({bottom:new Element("div",{style:"display: none;","class":"popover_content"}).update(t.me._getOrderDetailsDiv(e))})})}),t.me.observeClickNDbClick(t.orderLink,function(a){t.btn=a.target,jQuery(t.btn).popover("hide"),t.me._openDetailsPage(e)},function(e){}),t.newDiv},_getPaymentCell:function(e,t){var a={};switch(a.me=this,t){case"totalAmount":a.name="Total Amout",a.fieldName="totalAmount";break;case"totalPaid":a.name="Total Paid",a.fieldName="totalPaid";break;case"totalCreditNoteValue":a.name="Total Credit Note Value",a.fieldName="totalCreditNoteValue";break;default:a.name="ERROR(_getPaymentCell)"}return new Element("a",{href:"javascript: void(0);"}).insert({bottom:e.passPaymentCheck&&"totalPaid"===t?new Element("span",{title:Math.round(e.totalDue,2)<=0?"Full Paid":"Short Paid","class":Math.round(e.totalDue,2)<=0?"text-success":"text-danger"}).setStyle("margin-right: 3px;").update(new Element("span",{"class":"glyphicon "+(Math.round(e.totalDue,2)<=0?"glyphicon-ok-sign":"glyphicon-warning-sign")})):""}).insert({bottom:new Element("span").update(a.currencyValue=a.me.getCurrency(e[a.fieldName])).writeAttribute("title",a.name+":"+a.currencyValue)}).observe("click",function(){"totalCreditNoteValue"===a.fieldName?window.open("/creditnote.html?orderid="+e.id,"_blank"):a.me._openDetailsPage(e)})},_getMarginCell:function(e){var t={};return t.me=this,new Element("a",{href:"javascript: void(0);"}).insert({bottom:new Element("span").update(t.me.getCurrency(e.margin)).writeAttribute("title","Order margin:"+t.me.getCurrency(e.margin))}).observe("click",function(){t.me._openDetailsPage(e)})},_getPurchasingCell:function(e){var t={};return t.me=this,t.statusId_stockchecked=["4","5","6","7","8"],t.statusId_stockchecked_not_passed=["4","6"],t.hasCheckedStock=t.statusId_stockchecked.indexOf(e.status.id)>=0,t.stockChkedWIssues=t.statusId_stockchecked_not_passed.indexOf(e.status.id)>=0,new Element("div").insert({bottom:t.hasCheckedStock?new Element("a",{href:"javascript: void(0);","class":t.stockChkedWIssues?"text-danger":"text-success",title:e.stockChkedWIssues?"insufficient stock":"Stock checked"}).update(new Element("span",{"class":"glyphicon "+(t.stockChkedWIssues?"glyphicon-warning-sign":"glyphicon-ok-sign")})).observe("click",function(){t.me._openDetailsPage(e)}):""})},_getWarehouseCell:function(e){var t={};return t.me=this,t.statusId_whchecked=["6","7","8"],t.statusId_whchecked_not_passed=["6"],t.hasChecked=t.statusId_whchecked.indexOf(e.status.id)>=0,t.chkedWIssues=t.statusId_whchecked_not_passed.indexOf(e.status.id)>=0,new Element("div").insert({bottom:t.hasChecked?new Element("a",{href:"javascript: void(0);","class":t.chkedWIssues?"text-danger":"text-success",title:e.chkedWIssues?"insufficient stock":"Stock Handled successfully"}).update(new Element("span",{"class":"glyphicon "+(t.chkedWIssues?"glyphicon-warning-sign":"glyphicon-ok-sign")})).observe("click",function(){t.me._openDetailsPage(e)}):""})},_getResultRow:function(e,t){var a={};return a.me=this,a.isTitle=t||!1,a.deliveryMethod=a.isTitle?"D.Method":e.infos[9]?e.infos[9][0].value:"",a.row=new Element("tr",{"class":a.isTitle===!0?"":"order_item",order_id:e.id}).store("data",e).insert({bottom:new Element("td",{"class":"orderInfo  col-xs-1"}).update(a.isTitle?"Order No.":a.me._getOrderInfoCell(e))}).insert({bottom:new Element("td",{"class":"order-date col-xs-1"}).update(a.isTitle===!0?"Order Date":moment(a.me.loadUTCTime(e.orderDate)).format("ll"))}).insert({bottom:new Element("td",{"class":"invoiceNo col-xs-1"}).update(a.isTitle===!0?"Inv. No.":new Element("small").update(e.invNo))}).insert({bottom:new Element("td",{"class":"customer"}).update(a.isTitle===!0?"Customer":e.customer.name)}).insert({bottom:new Element("td",{"class":"col-xs-3"}).update(new Element("div",{"class":"row"}).insert({bottom:new Element("div",{"class":"text-right col-xs-3 "}).update(a.isTitle?"Total Amt":a.me._getPaymentCell(e,"totalAmount"))}).insert({bottom:new Element("div",{"class":"text-right col-xs-4 "}).update(a.isTitle?"Paid Amt":a.me._getPaymentCell(e,"totalPaid"))}).insert({bottom:new Element("div",{"class":"col-xs-2 "+(e.totalCreditNoteValue>0?"tr-red":"")}).setStyle("padding: 0px;").update(a.isTitle?"Credit Amt":a.me._getPaymentCell(e,"totalCreditNoteValue"))}).insert({bottom:new Element("div",{"class":"text-right col-xs-3 "}).update(a.isTitle?"Margin":a.me._getMarginCell(e))}))}).insert({bottom:new Element("td",{"class":"col-xs-1"}).update(new Element("div",{"class":"row"}).insert({bottom:new Element("div",{"class":"col-xs-6 text-center",title:"Purchasing"}).update(a.isTitle?"Pur.":a.me._getPurchasingCell(e))}).insert({bottom:new Element("div",{"class":"col-xs-6 text-center",title:"Warehouse"}).update(a.isTitle?"Ware.":a.me._getWarehouseCell(e))}))}).insert({bottom:new Element("td",{"class":"status col-xs-1 truncate",title:e.status.name,order_status:e.status.name}).update(e.status?e.status.name:"")}).insert({bottom:a.deliveryMethodEl=new Element("td",{"class":"col-xs-1 truncate"+(a.deliveryMethod.toLowerCase().indexOf("pickup")>-1?" danger":""),title:a.deliveryMethod}).update(a.deliveryMethod)}),a.me.observeClickNDbClick(a.deliveryMethodEl,function(){},a.isTitle?function(){}:function(){a.me.showModalBox("Delivery Method for Order "+e.orderNo,a.deliveryMethod)}),a.row},_initDeliveryMethods:function(){var e={};return e.me=this,e.selectBox=$(e.me.searchDivId).down('[search_field="delivery_method"]'),e.me._signRandID(e.selectBox),jQuery("#"+e.selectBox.id).select2({minimumInputLength:3,multiple:!0,ajax:{delay:250,url:"/ajax/getDeliveryMethods",type:"POST",data:function(e){return{searchTxt:e}},results:function(t,a,n){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t+"{|}",text:t.stripTags()})}),{results:e.result}},cache:!0}}),e.me},_initCustomerSelect2:function(){var e={};return e.me=this,e.selectBox=$(e.me.searchDivId).down("#custName"),e.me._signRandID(e.selectBox),jQuery("#"+e.selectBox.id).select2({minimumInputLength:3,multiple:!1,allowClear:!0,ajax:{delay:250,url:"/ajax/getCustomers",type:"POST",data:function(e){return{searchTxt:e}},results:function(t,a,n){return e.result=[],t.resultData&&t.resultData.items&&t.resultData.items.each(function(t){e.result.push({id:t.name,text:t.name,data:t})}),{results:e.result}},cache:!0}}),e.me},_changeType:function(e){var t={};switch(t.me=this,jQuery(".type-swither-item.active").removeClass("active"),t.me._type=$(e).addClassName("active").readAttribute("data-type"),t.me._extraSearchCriteria=$(e).readAttribute("extraSearchCriteria"),t.panelClass="panel-default",t.me._type){case"ORDER":t.panelClass="panel-success";break;case"INVOICE":t.panelClass="panel-default";break;case"QUOTE":t.panelClass="panel-warning"}return $(e).up(".panel").removeClassName("panel-success").removeClassName("panel-default").removeClassName("panel-warning").addClassName(t.panelClass),$("searchBtn").click(),t.me},_initTypeSwither:function(){var e={};return e.me=this,$$(".type-swither-item").each(function(t){t.observe("click",function(){e.me._changeType(this)})}),e.me},init:function(){var e={};return e.me=this,jQuery(".datepicker").datetimepicker({format:"DD/MM/YYYY"}),e.me._initDeliveryMethods()._initCustomerSelect2()._initTypeSwither(),$("right-panel").store("InsufficientStockOrdersListPanelJs",e.insufficientStockOrdersListPanelJs=new InsufficientStockOrdersListPanelJs(e.me)).update(e.insufficientStockOrdersListPanelJs.getListPanel().addClassName("panel-default")),e.insufficientStockOrdersListPanelJs.load(),e.me}});